# yaml-language-server: $schema=https://raw.githubusercontent.com/flatpak/flatpak-builder/main/data/flatpak-manifest.schema.json

id: com.protonvpn.www
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: protonvpn-app
finish-args:
  - --share=ipc
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  # To store credentials
  - --talk-name=org.freedesktop.secrets
  # To check the Network Manager status on the host system
  - --system-talk-name=org.freedesktop.NetworkManager
  # The downloaded OpenVPN profile hardcodes the certificate path
  - --filesystem=~/.cert/nm-openvpn/
  # In case ~/.cert is not created
  - --filesystem=~/.cert:create
  # For bug report
  - --filesystem=/var/log/journal:ro
  # For DBus daemon reconnector
  - --system-talk-name=org.freedesktop.login1
  # New dbus session name
  - --own-name=proton.vpn.app.gtk
  # Tray icon
  - --talk-name=org.kde.StatusNotifierWatcher

modules:
  - shared-modules/intltool/intltool-0.51.json
  - name: libayatana-appindicator
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_BINDINGS_MONO=NO
      - -DENABLE_BINDINGS_VALA=NO
      - -DENABLE_GTKDOC=NO
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-appindicator.git
        tag: 0.5.94
        commit: 31e8bb083b307e1cc96af4874a94707727bd1e79
        x-checker-data:
          type: anitya
          project-id: 18446
          tag-template: $version
    modules:
      - name: ayatana-ido
        buildsystem: cmake-ninja
        sources:
          - type: git
            url: https://github.com/AyatanaIndicators/ayatana-ido.git
            tag: 0.10.4
            commit: f968079b09e2310fefc3fc307359025f1c74b3eb
            x-checker-data:
              type: anitya
              project-id: 18445
              tag-template: $version

      - name: libayatana-indicator
        buildsystem: cmake-ninja
        sources:
          - type: git
            url: https://github.com/AyatanaIndicators/libayatana-indicator.git
            tag: 0.9.4
            commit: 611bb384b73fa6311777ba4c41381a06f5b99dad
            x-checker-data:
              type: anitya
              project-id: 18447
              tag-template: $version

      - name: libdbusmenu-gtk3
        buildsystem: autotools
        build-options:
          cflags: -Wno-error
        config-opts:
          - --with-gtk=3
          - --disable-dumper
          - --disable-static
          - --enable-tests
          - --disable-gtk-doc
          - --enable-introspection=no
          - --disable-vala
        cleanup:
          - /share/gtk-doc
          - /share/libdbusmenu
        sources:
          - type: archive
            url: https://launchpad.net/libdbusmenu/16.04/16.04.0/+download/libdbusmenu-16.04.0.tar.gz
            sha256: b9cc4a2acd74509435892823607d966d424bd9ad5d0b00938f27240a1bfa878a

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "packaging" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/20/12/38679034af332785aac8774540895e234f4d07f7545804097de4b666afd8/packaging-25.0-py3-none-any.whl
        sha256: 29572ef2b1f17581046b3a2227d5c611fb25ec70ca1ba8554b24b0e69331a484
        x-checker-data:
          name: packaging
          packagetype: bdist_wheel
          type: pypi
    modules:
      - name: python3-toml
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
            sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
            x-checker-data:
              type: pypi
              name: toml

  # Required by OpenSSL/crypto.py at runtime
  - name: python-typing-extensions
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/72/94/1a15dd82efb362ac84269196e94cf00f187f7ed21c242792a923cdb1c61f/typing_extensions-4.15.0.tar.gz
        sha256: 0cea48d173cc12fa28ecabc3b837ea3cf6f38c6d1136f85cbaaf598984861466
        x-checker-data:
          type: pypi
          name: typing_extensions
    modules:
      - name: python3-flit_core
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "flit_core" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/69/59/b6fc2188dfc7ea4f936cd12b49d707f66a1cb7a1d2c16172963534db741b/flit_core-3.12.0.tar.gz
            sha256: 18f63100d6f94385c6ed57a72073443e1a71a4acb4339491615d0f16d6ff01b2
            x-checker-data:
              type: pypi
              name: flit_core

  # The bcrypt Python library is handled specially since it has Rust code and dependencies.
  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-bcrypt
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-bcrypt/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "bcrypt" --no-build-isolation
    modules:
      # Python dependencies required to build things
      # https://github.com/flathub/org.thonny.Thonny/blob/2f10b0123b1df4111c4c4fb3277fdebab56c7e73/org.thonny.Thonny.yaml#L75-L234

      - name: python3-flit_core
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "flit_core" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/69/59/b6fc2188dfc7ea4f936cd12b49d707f66a1cb7a1d2c16172963534db741b/flit_core-3.12.0.tar.gz
            sha256: 18f63100d6f94385c6ed57a72073443e1a71a4acb4339491615d0f16d6ff01b2
            x-checker-data:
              type: pypi
              name: flit_core
      - name: python3-poetry-core
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/54/ef/a16c11de95b638341961765e072dfdd4c9a0be51d6b22d594c5f3255e4bb/poetry_core-2.2.1.tar.gz
            sha256: 97e50d8593c8729d3f49364b428583e044087ee3def1e010c6496db76bd65ac5
            x-checker-data:
              type: pypi
              name: poetry-core
      - name: python3-setuptools_scm
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/10/5e/1aa9a93198c6b64513c9d7752de7422c06402de6600a8767da1524f9570b/pyparsing-3.2.5-py3-none-any.whl
            sha256: e38a4f02064cf41fe6593d328d0512495ad1f3d8a91c4f73fc401b3079a59a5e
            x-checker-data:
              name: pyparsing
              packagetype: bdist_wheel
              type: pypi
          - type: file
            url: https://files.pythonhosted.org/packages/77/b8/0135fadc89e73be292b473cb820b4f5a08197779206b33191e801feeae40/tomli-2.3.0-py3-none-any.whl
            sha256: e95b1af3c5b07d9e643909b5abbec77cd9f1217e6d0bca72b0234736b9fb1f1b
            x-checker-data:
              name: tomli
              packagetype: bdist_wheel
              type: pypi
          - type: file
            url: https://files.pythonhosted.org/packages/3d/ea/ac2bf868899d0d2e82ef72d350d97a846110c709bacf2d968431576ca915/setuptools_scm-9.2.2-py3-none-any.whl
            sha256: 30e8f84d2ab1ba7cb0e653429b179395d0c33775d54807fc5f1dd6671801aef7
            x-checker-data:
              name: setuptools_scm
              packagetype: bdist_wheel
              type: pypi
      - name: python3-setuptools_rust
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/7d/31/f2289ce78b9b473d582568c234e104d2a342fd658cc288a7553d83bb8595/semantic_version-2.10.0.tar.gz
            sha256: bdabb6d336998cbb378d4b9db3a4b56a1e3235701dc05ea2690d9a997ed5041c
            x-checker-data:
              type: pypi
              name: semantic_version
          - type: file
            url: https://files.pythonhosted.org/packages/bc/c4/8d3d282cee60d3ea0369fa15ce27387810040360adb4133e31990a7a2aba/setuptools_rust-1.12.0.tar.gz
            sha256: d94a93f0c97751c17014565f07bdc324bee45d396cd1bba83d8e7af92b945f0c
            x-checker-data:
              type: pypi
              name: setuptools-rust
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d4/36/3329e2518d70ad8e2e5817d5a4cac6bba05a47767ec416c7d020a965f408/bcrypt-5.0.0.tar.gz
        sha256: f748f7c2d6fd375cc93d3fba7ef4a9e3a092421b8dbf34d8d4dc06be9492dfdd
        x-checker-data:
          type: pypi
          name: bcrypt
      # The Cargo sources should be updated whenever bcrypt is updated.
      # wget https://raw.githubusercontent.com/pyca/bcrypt/refs/tags/5.0.0/src/_bcrypt/Cargo.lock -O /tmp/Cargo.lock
      # python flatpak-builder-tools/cargo/flatpak-cargo-generator.py -o bcrypt-cargo-sources.json /tmp/Cargo.lock
      - bcrypt-cargo-sources.json

  - name: libndp
    buildsystem: autotools
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/jpirko/libndp/archive/v1.9.tar.gz
        sha256: e564f5914a6b1b799c3afa64c258824a801c1b79a29e2fe6525b682249c65261
        x-checker-data:
          type: anitya
          project-id: 14944
          stable-only: true
          url-template: https://github.com/jpirko/libndp/archive/v$version.tar.gz

  # https://github.com/flathub/com.anydesk.Anydesk/blob/f06549a3749ecbcc99cbbfd7753bfa884746b404/com.anydesk.Anydesk.json#L84-L115
  - name: polkit
    buildsystem: meson
    config-opts:
      - -Dlibs-only=true
      - -Dman=false
      - -Dintrospection=false
      - -Dexamples=false
      - -Dgtk_doc=false
      - -Dauthfw=shadow
    cleanup:
      - /bin/*
      - /etc/pam.d
      - /etc/dbus-1
      - /share/dbus-1/system-services/*
      - /share/polkit-1
      - /share/polkit-1/actions/*
      - /lib/polkit-1
      - /include
    sources:
      - x-checker-data:
          type: anitya
          project-id: 3682
          url-template: >-
            https://gitlab.freedesktop.org/polkit/polkit/-/archive/$version/polkit-$version.tar.gz
        type: archive
        url: >-
          https://gitlab.freedesktop.org/polkit/polkit/-/archive/124/polkit-124.tar.gz
        sha256: 72457d96a0538fd03a3ca96a6bf9b7faf82184d4d67c793eb759168e4fd49e20

  # https://github.com/flathub/org.gnome.NetworkDisplays/blob/5a3369d04e32ccd092e42463de5171f473a8601d/org.gnome.NetworkDisplays.json#LL177C11-L230C11
  - name: NetworkManager
    buildsystem: meson
    build-options:
      cflags: -ltinfo
      cxxflags: -ltinfo
    config-opts:
      - -Dsystemdsystemunitdir=no
      - -Ddbus_conf_dir=/app/etc/dbus-1/system.d
      - -Diptables=/usr/bin/true
      - -Ddnsmasq=/usr/bin/true
      - -Dsession_tracking=no
      - -Dselinux=false
      - -Dsystemd_journal=false
      - -Dlibaudit=no
      - -Dwext=false
      - -Dwifi=false
      - -Dppp=false
      - -Dmodem_manager=false
      - -Dovs=false
      - -Dnmcli=false
      - -Dnmtui=false
      # We need introspection
      - -Dintrospection=true
      - -Dvapi=false
      - -Ddocs=false
      - -Dtests=no
      - -Dfirewalld_zone=false
      - -Dlibpsl=false
      - -Dqt=false
    cleanup:
      - /sbin
      - /etc
      - /include
      - /lib/pkgconfig
      - /libexec
      - /var
      - /share/bash-completion
      - /share/doc
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git
        tag: 1.40.18
        commit: 2db3748ec8162ce948ba52f71b42a258ff8d64ba
        x-checker-data:
          type: anitya
          project-id: 21197
          stable-only: true
          tag-template: $version
          versions:
            # Breaking change in 1.42.x: `dns` will be replaced by `dns-data`, which is incompatible with older NetworkManager on the host system
            <: 1.42.0

      # To fix `Support for given configuration is not implemented` when trying to connect: https://github.com/flathub/com.protonvpn.www/issues/2
      # Copied from https://github.com/flathub/com.github.jkotra.eovpn/blob/670f19e2aee1c9559fbe4eed904e35500843ae88/0001-disable-ownership-check-for-plugins.patch
      - type: patch
        path: patches/NetworkManager/disable-ownership-check-for-plugins.patch

  # https://github.com/flathub/com.github.jkotra.eovpn/blob/670f19e2aee1c9559fbe4eed904e35500843ae88/com.github.jkotra.eovpn.yml#L133C17-L151
  - name: libnma
    buildsystem: meson
    config-opts:
      - -Dmobile_broadband_provider_info=false
      - -Dgtk_doc=false
      - -Dintrospection=false
      - -Dvapi=false
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libnma/-/archive/1.10.6/libnma-1.10.6.tar.gz
        sha256: c88fd3408c4ff166b06179b5ce5186e08a57b64eb8c9b22e055ca0dbc5e8002b
        x-checker-data:
          type: anitya
          project-id: 230112
          stable-only: true
          url-template: https://gitlab.gnome.org/GNOME/libnma/-/archive/$version/libnma-$version.tar.gz

  - name: NetworkManager-openvpn
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/NetworkManager/NetworkManager-openvpn.git
        tag: 1.10.2
        commit: ae9575dd07cc2d2d51ec8d0297823e07017cb6e6
        x-checker-data:
          type: anitya
          project-id: 69977
          stable-only: true
          tag-template: $version
          versions:
            # 1.10.4 causes connection failure
            <: 1.10.4

  # Logs submission when reporting a bug requires journalctl
  # https://github.com/flathub/org.gnome.Logs/blob/master/org.gnome.Logs.json#L69C9-L146C11
  - name: systemd
    buildsystem: meson
    config-opts:
      - --libdir=lib
      - -Dsysconfdir=/app/etc
      - -Ddocdir=/app/share/doc
      - -Dsysvinit-path=/app/etc/init.d
      - -Dfdisk=false
      - -Ddbus=false
      - -Dutmp=false
      - -Dhibernate=false
      - -Dldconfig=false
      - -Dresolve=false
      - -Defi=false
      - -Dtpm=false
      - -Denvironment-d=false
      - -Dbinfmt=false
      - -Dcoredump=false
      - -Dlogind=false
      - -Dhostnamed=false
      - -Dlocaled=false
      - -Dmachined=false
      - -Dportabled=false
      - -Dnetworkd=false
      - -Dtimedated=false
      - -Dtimesyncd=false
      - -Dremote=false
      - -Dnss-myhostname=false
      - -Dnss-mymachines=false
      - -Dnss-resolve=false
      - -Dnss-systemd=false
      - -Dfirstboot=false
      - -Drandomseed=false
      - -Dbacklight=false
      - -Dvconsole=false
      - -Dquotacheck=false
      - -Dsysusers=false
      - -Dtmpfiles=false
      - -Dimportd=false
      - -Dhwdb=false
      - -Drfkill=false
      - -Dman=false
      - -Dhtml=false
      - -Dbashcompletiondir=no
      - -Dzshcompletiondir=no
    cleanup:
      # - /bin
      - /etc
      - /lib/libudev*
      - /lib/kernel
      - /lib/modprobe.d
      - /lib/rpm
      - /lib/sysctl.d
      # - /lib/systemd
      - /lib/udev
      - /app/share/doc
      - /share/dbus-1
      - /share/doc
      - /share/factory
      - /share/glib-2.0
      - /share/icons
      - /share/man
      - /share/pkgconfig
      - /share/polkit-1
      - /share/runtime
    sources:
      - type: git
        url: https://github.com/systemd/systemd.git
        tag: v258.3
        commit: 56a85121cd3502e824ed368a6b06dda924932bcf
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  ######### Cryptography #########
  # https://github.com/flathub/org.gajim.Gajim/blob/cb9cb26dd58acea79c50b316fb66a171b54c18e1/org.gajim.Gajim.yaml#LL66-L131C81

  - name: python3-pycparser
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pycparser" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/a0/e3/59cd50310fc9b59512193629e1984c1f95e5c8ae6e5d8c69532ccc65a7fe/pycparser-2.23-py3-none-any.whl
        sha256: e5c6e8d3fbad53479cab09ac03729e0a9faf2bee3db8208a550daf5af81a5934
        x-checker-data:
          type: pypi
          name: pycparser
          packagetype: bdist_wheel

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/eb/56/b1ba7935a17738ae8453301356628e8147c79dbb825bcbc73dc7401f9846/cffi-2.0.0.tar.gz
        sha256: 44d1b5909021139fe36001ae048dbdde8214afa20200eda0f64c068cac5d5529
        x-checker-data:
          type: pypi
          name: cffi

  - name: python3-asn1crypto
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "asn1crypto" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c9/7f/09065fd9e27da0eda08b4d6897f1c13535066174cc023af248fc2a8d5e5a/asn1crypto-1.5.1-py2.py3-none-any.whl
        sha256: db4e40728b728508912cbb3d44f19ce188f218e9eba635821bb4b68564f8fd67
        x-checker-data:
          type: pypi
          name: asn1crypto
          packagetype: bdist_wheel

  - name: python3-idna
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "idna" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/0e/61/66938bbb5fc52dbdf84594873d5b51fb1f7c7794e9c0f5bd885f30bc507b/idna-3.11-py3-none-any.whl
        sha256: 771a87f49d9defaf64091e6e6fe9c18d4833f140bd19464795bc32d966ca37ea
        x-checker-data:
          type: pypi
          name: idna
          packagetype: bdist_wheel

  - name: python3-cryptography
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/4b/0a/863a3604112174c8624a2ac3c038662d9e59970c7f926acdcfaed8d61142/cryptography-46.0.3-cp311-abi3-manylinux_2_28_aarch64.whl
        sha256: 6eae65d4c3d33da080cff9c4ab1f711b15c1d9760809dad6ea763f3812d254cb
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query:
            .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp311-abi3-manylinux_2_28_aarch64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel

      - type: file
        url: https://files.pythonhosted.org/packages/c9/56/e7e69b427c3878352c2fb9b450bd0e19ed552753491d39d7d0a2f5226d41/cryptography-46.0.3-cp311-abi3-manylinux_2_28_x86_64.whl
        sha256: a2c0cd47381a3229c403062f764160d57d4d175e022c1df84e168c6251a22eec
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query:
            .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp311-abi3-manylinux_2_28_x86_64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel

  # The pyopenssl Python library is handled specially since it depends on the above python3-cryptography module.
  - name: python3-pyopenssl
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pyopenssl" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/d1/81/ef2b1dfd1862567d573a4fdbc9f969067621764fbb74338496840a1d2977/pyopenssl-25.3.0-py3-none-any.whl
        sha256: 1fda6fc034d5e3d179d39e59c1895c9faeaf40a79de5fc4cbbfbe0d36f4a77b6
        x-checker-data:
          name: pyOpenSSL
          packagetype: bdist_wheel
          type: pypi

  # https://github.com/flathub/net.lutris.Lutris/blob/7bd51222b8076abd8fcbfe9cb0e4d6e70bafca24/net.lutris.Lutris.yml#L647C1-L740C81
  - name: python-ninja # needed by dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py build -j${FLATPAK_BUILDER_N_JOBS} -DARCHIVE_DOWNLOAD_DIR="${FLATPAK_BUILDER_BUILDDIR}"
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    build-options:
      env:
        CMAKE_POLICY_VERSION_MINIMUM: '3.5'
    cleanup: ['*']
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/37/2c/d717d13a413d6f7579cdaa1e28e6e2c98de95461549b08d311c8a5bf4c51/ninja-1.11.1.1.tar.gz
        sha256: 9d793b08dd857e38d0b6ffe9e6b7145d7c485a42dcfea04905ca0cdb6017cc3c

      - type: file
        url: https://github.com/Kitware/ninja/archive/refs/tags/v1.11.1.g95dee.kitware.jobserver-1.tar.gz
        sha256: 7ba84551f5b315b4270dc7c51adef5dff83a2154a3665a6c9744245c122dd0db
    modules:
      - pip-resources.python-skbuild.yaml
      - name: python-skbuild
        buildsystem: simple
        build-commands:
          - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
            .
        cleanup: ['*']
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/9e/e2/2e440c30e93fc5b505ee56169a4396b05e797a1daadb721aba429adbfd51/scikit-build-0.15.0.tar.gz
            sha256: e723cd0f3489a042370b9ea988bbb9cfd7725e8b25b20ca1c7981821fcf65fb9
        modules:
          - name: python-setuptools-scm
            buildsystem: simple
            build-commands:
              - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                .
            cleanup: ['*']
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/7b/b1/19587742aad604f1988a8a362e660e8c3ac03adccdb71c96d86526e5eb62/setuptools_scm-9.2.2.tar.gz
                sha256: 1c674ab4665686a0887d7e24c03ab25f24201c213e82ea689d2f3e169ef7ef57
                x-checker-data:
                  type: pypi
                  name: setuptools_scm
            modules:
              - name: python-tomli
                buildsystem: simple
                build-commands:
                  - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                    .
                cleanup: ['*']
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/52/ed/3f73f72945444548f33eba9a87fc7a6e969915e7b1acc8260b30e1f76a2f/tomli-2.3.0.tar.gz
                    sha256: 64be704a875d2a59753d80ee8a533c3fe183e3f06807ff7dc2232938ccb01549
                    x-checker-data:
                      type: pypi
                      name: tomli
          - name: python-distro # also needed by Lutris, do not add a cleanup property here!
            buildsystem: simple
            build-commands:
              - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                .
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/fc/f8/98eea607f65de6527f8a2e8885fc8015d3e6f5775df186e443e0964a11c3/distro-1.9.0.tar.gz
                sha256: 2fa77c6fd8940f116ee1d6b94a2f90b13b5ea8d019b98bc8bafdcabcdd9bdbed
                x-checker-data:
                  type: pypi
                  name: distro

  - name: python-meson # needed by dbus-python, the meson version shipped by the SDK is too old (0.59<0.60)
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" --ignore-installed
        .
    cleanup: ['*']
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/45/76/c2f4cff5dabcd64711bd327dd00fd22ec603bed6a928dd5d058044d568d8/meson-1.10.0.tar.gz
        sha256: 8071860c1f46a75ea34801490fd1c445c9d75147a65508cd3a10366a7006cc1c
        x-checker-data:
          type: pypi
          name: meson

  # https://github.com/flathub/net.lutris.Lutris/blob/7bd51222b8076abd8fcbfe9cb0e4d6e70bafca24/net.lutris.Lutris.yml#L772-L786
  - name: python-dbus
    buildsystem: simple
    build-commands:
      # Setting `PYTHONPATH` and using the deprecated `./setup.py install`
      # in the following line are workarounds to force usage of the newer
      # meson version installed above
      #
      # The next FreeDesktop SDK update should make this (and installing
      # our own version of meson) unnecessary.
      - PYTHONPATH=/app/lib/python3.11/site-packages python3 ./setup.py install --prefix="${FLATPAK_DEST}"
        --root=/
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.3.2.tar.gz
        sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8
        x-checker-data:
          type: anitya
          project-id: 402
          url-template: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-$version.tar.gz

  # For network status detection: https://github.com/ProtonVPN/proton-vpn-gtk-app/blob/a6a3ea0b2a0c17ebbba4eb9f80c8b164092050b9/proton/vpn/app/gtk/services/reconnector/network_monitor.py#L41
  - name: iproute2
    buildsystem: autotools
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
      - SBINDIR=${FLATPAK_DEST}/bin
      - CONFDIR=${FLATPAK_DEST}/etc/iproute2
    sources:
      - type: archive
        url: https://www.kernel.org/pub/linux/utils/net/iproute2/iproute2-6.18.0.tar.xz
        sha256: 6ba520e1975e4c50dc931eeae91ea37c198b8a173744885f8895b84325f9d456
        x-checker-data:
          project-id: 1392
          stable-only: true
          type: anitya
          url-template: https://www.kernel.org/pub/linux/utils/net/iproute2/iproute2-$version.tar.xz

  ######### Proton Services #########

  - name: python-proton-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//49' "expandvars" "requests" "python-gnupg" "aiohttp" "pyxdg" -o pip-resources.python-proton-core
      # `expandvars` is required by `yarl`
      # https://github.com/ProtonVPN/python-proton-core/blob/8ab41013fcedd8fe16dffe0992f60cbdbd01fe0b/setup.py#L12C23-L12C129
      - pip-resources.python-proton-core.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-core
        tag: v0.7.0
        commit: f7a178a99c3adc0e88c7f91d4db5371a052c4985
        x-checker-data:
          type: anitya
          project-id: 369954
          tag-template: v$version

  - name: python-proton-keyring-linux
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//49' "keyring" -o pip-resources.python-proton-keyring-linux
      # https://github.com/ProtonVPN/python-proton-keyring-linux/blob/5ff3c7f9a1a162836649502dd23c2fbe1f487d73/setup.py#L12C39-L12C46
      # Remove the cryptography module as it has been included above
      - pip-resources.python-proton-keyring-linux.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-keyring-linux
        tag: v0.2.1
        commit: 1534c2f09d73ad18a073c09dd314e11c9da895e0
        x-checker-data:
          type: anitya
          project-id: 369953
          tag-template: v$version

  - name: python-proton-vpn-api-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # Add "proton-vpn-local-agent" here as well so that the python distribution metadata is included
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//49' "fido2" "distro" "sentry-sdk" "PyNaCl" "proton-vpn-local-agent" -o pip-resources.python-proton-vpn-api-core
      # https://github.com/ProtonVPN/python-proton-vpn-api-core/blob/e26e3fa70077d24a53465c87ebdd6026e3c7c080/setup.py#L17-L18C46
      - pip-resources.python-proton-vpn-api-core.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-vpn-api-core
        tag: v4.14.1
        commit: 816b342ece6369e159278a9eea05539d0374cd2f
        disable-submodules: true
        x-checker-data:
          type: anitya
          project-id: 369944
          tag-template: v$version

  - name: python-proton-vpn-network-manager
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//49' "proton-vpn-local-agent" "pygobject" "pycairo" -o pip-resources.python-proton-vpn-network-manager
      # https://github.com/ProtonVPN/python-proton-vpn-network-manager/blob/6ffd04fa0ae88a89d2b733443317066ef23b3ccd/setup.py#L14C63-L14C85
      - pip-resources.python-proton-vpn-network-manager.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-vpn-network-manager
        tag: v0.13.5
        commit: 3a3646d5a158ef610b8cf956b155704f6d04ec0a
        disable-submodules: true
        x-checker-data:
          type: anitya
          project-id: 369947
          tag-template: v$version
      - type: patch
        path: patches/python-proton-vpn-network-manager/fix-ip-path.patch

  - name: python-proton-vpn-local-agent
    buildsystem: simple
    build-commands:
      - bsdtar -Oxf python-proton-vpn-local-agent.deb data.tar.xz | bsdtar -xf -
      - |
        PYTHON_VERSION=$(python3 -c 'import sys; print("{}.{}".format(*sys.version_info))');
        install -Dm755 usr/lib/python3/dist-packages/proton/vpn/local_agent.abi3.so "${FLATPAK_DEST}/lib/python${PYTHON_VERSION}/site-packages/proton/vpn/local_agent.abi3.so"
    sources:
      - type: file
        only-arches: [x86_64]
        dest-filename: python-proton-vpn-local-agent.deb
        url: https://repo.protonvpn.com/debian/dists/stable/main/binary-amd64/python3-proton-vpn-local-agent_1.6.0_amd64.deb
        sha256: 3a29e7de6c5230e70a230afa918bf60551c20d2a8c669d89640f793eaaf477ed
        x-checker-data:
          type: debian-repo
          package-name: python3-proton-vpn-local-agent
          root: https://repo.protonvpn.com/debian
          dist: stable
          component: main
      - type: file
        only-arches: [aarch64]
        dest-filename: python-proton-vpn-local-agent.deb
        url: https://repo.protonvpn.com/debian/dists/stable/main/binary-arm64/python3-proton-vpn-local-agent_1.6.0_arm64.deb
        sha256: 7c8b4b75e8165c35e6b79e6fd7a9906b6798f6dbf43ba5457b07f07f14c9899c
        x-checker-data:
          type: debian-repo
          package-name: python3-proton-vpn-local-agent
          root: https://repo.protonvpn.com/debian
          dist: stable
          component: main

  - name: proton-vpn-gtk-app
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation

      - install -Dm644 rpmbuild/SOURCES/proton.vpn.app.gtk.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-icon ${FLATPAK_ID} --set-key Exec --set-value 'protonvpn-app
        %u' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      - install -Dm644 rpmbuild/SOURCES/proton-vpn-logo.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      # Export icons that can be used in the status bar: https://github.com/flathub/com.protonvpn.www/issues/100
      # Icons to be exported must have names following the pattern: ${FLATPAK_ID}.icon_name.svg
      - |
        PYTHON_VERSION=$(python3 -c 'import sys; print("{}.{}".format(*sys.version_info))')
        PYTHONPATH=${FLATPAK_DEST}/lib/python${PYTHON_VERSION}/site-packages
        for icon in maintenance-icon proton-vpn-sign state-connected state-disconnected state-error
        do
          mv ${PYTHONPATH}/proton/vpn/app/gtk/assets/icons/${icon}.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.${icon}.svg
          ln -s ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.${icon}.svg ${PYTHONPATH}/proton/vpn/app/gtk/assets/icons/${icon}.svg
        done
      - install -Dm644 com.protonvpn.www.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//49' "pygobject" "pycairo" -o pip-resources.proton-vpn-gtk-app
      # https://github.com/ProtonVPN/proton-vpn-gtk-app/blob/9bb65236353d646b07ead7b417d3828b12b55b7c/setup.py#L12-L19
      - pip-resources.proton-vpn-gtk-app.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/proton-vpn-gtk-app
        tag: v4.13.1
        commit: 54b3ad74e1aefc989a6de4afed652df879c410e5
        disable-submodules: true
        x-checker-data:
          type: anitya
          project-id: 369943
          tag-template: v$version
          is-main-source: true

      - type: patch
        path: patches/proton-vpn-gtk-app/fix-tray-icons.patch

      - type: file
        path: com.protonvpn.www.metainfo.xml
