# yaml-language-server: $schema=https://raw.githubusercontent.com/flatpak/flatpak-builder/main/data/flatpak-manifest.schema.json

id: com.protonvpn.www
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: protonvpn-app
finish-args:
  - --share=ipc
  - --share=network
  - --socket=wayland
  - --socket=fallback-x11
  # To store credentials
  - --talk-name=org.freedesktop.secrets
  # To check the Network Manager status on the host system
  - --system-talk-name=org.freedesktop.NetworkManager
  # The downloaded OpenVPN profile hardcodes the certificate path
  - --filesystem=~/.cert/nm-openvpn/
  # In case ~/.cert is not created
  - --filesystem=~/.cert:create
  # For bug report
  - --filesystem=/var/log/journal:ro
  # For DBus daemon reconnector
  - --system-talk-name=org.freedesktop.login1
  # New dbus session name
  - --own-name=proton.vpn.app.gtk
  # Tray icon
  - --talk-name=org.kde.StatusNotifierWatcher

modules:
  - shared-modules/libsecret/libsecret.json
  - shared-modules/intltool/intltool-0.51.json
  - name: libayatana-appindicator
    buildsystem: cmake-ninja
    config-opts:
      - -DENABLE_BINDINGS_MONO=NO
      - -DENABLE_BINDINGS_VALA=NO
      - -DENABLE_GTKDOC=NO
    sources:
      - type: git
        url: https://github.com/AyatanaIndicators/libayatana-appindicator.git
        tag: 0.5.93
        commit: 238c8b02718fa5b4af95ede72beeed762094f4cc
        x-checker-data:
          type: anitya
          project-id: 18446
          tag-template: $version
    modules:
      - name: ayatana-ido
        buildsystem: cmake-ninja
        sources:
          - type: git
            url: https://github.com/AyatanaIndicators/ayatana-ido.git
            tag: 0.10.4
            commit: f968079b09e2310fefc3fc307359025f1c74b3eb
            x-checker-data:
              type: anitya
              project-id: 18445
              tag-template: $version

      - name: libayatana-indicator
        buildsystem: cmake-ninja
        sources:
          - type: git
            url: https://github.com/AyatanaIndicators/libayatana-indicator.git
            tag: 0.9.4
            commit: 611bb384b73fa6311777ba4c41381a06f5b99dad
            x-checker-data:
              type: anitya
              project-id: 18447
              tag-template: $version

      - name: libdbusmenu-gtk3
        buildsystem: autotools
        build-options:
          cflags: -Wno-error
        config-opts:
          - --with-gtk=3
          - --disable-dumper
          - --disable-static
          - --enable-tests
          - --disable-gtk-doc
          - --enable-introspection=no
          - --disable-vala
        cleanup:
          - /share/gtk-doc
          - /share/libdbusmenu
        sources:
          - type: archive
            url: https://launchpad.net/libdbusmenu/16.04/16.04.0/+download/libdbusmenu-16.04.0.tar.gz
            sha256: b9cc4a2acd74509435892823607d966d424bd9ad5d0b00938f27240a1bfa878a

  - name: python3-packaging
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "packaging" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/88/ef/eb23f262cca3c0c4eb7ab1933c3b1f03d021f2c48f54763065b6f0e321be/packaging-24.2-py3-none-any.whl
        sha256: 09abb1bccd265c01f4a3aa3f7a7db064b36514d2cba19a2f694fe6150451a759
        x-checker-data:
          name: packaging
          packagetype: bdist_wheel
          type: pypi
    modules:
      - name: python3-toml
        buildsystem: simple
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "toml" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz
            sha256: b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f
            x-checker-data:
              type: pypi
              name: toml

  # The bcrypt Python library is handled specially since it has Rust code and dependencies.
  # The cryptography Python library is handled specially since it has Rust code and dependencies.
  - name: python3-bcrypt
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/python3-bcrypt/cargo
        CARGO_NET_OFFLINE: 'true'
        RUST_BACKTRACE: '1'
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "bcrypt" --no-build-isolation
    modules:
      # Python dependencies required to build things
      # https://github.com/flathub/org.thonny.Thonny/blob/2f10b0123b1df4111c4c4fb3277fdebab56c7e73/org.thonny.Thonny.yaml#L75-L234

      - name: python3-flit_core
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "flit_core" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/d5/ae/09427bea9227a33ec834ed5461432752fd5d02b14f93dd68406c91684622/flit_core-3.10.1.tar.gz
            sha256: 66e5b87874a0d6e39691f0e22f09306736b633548670ad3c09ec9db03c5662f7
            x-checker-data:
              type: pypi
              name: flit_core
      - name: python3-poetry-core
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "poetry-core" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/c7/5c/3609519b7d890ced542fe327ea26a7c8ea55ef298c323c46cca2a011c1cb/poetry_core-1.9.1.tar.gz
            sha256: 7a2d49214bf58b4f17f99d6891d947a9836c9899a67a5069f52d7b67217f61b8
            x-checker-data:
              type: pypi
              name: poetry-core
      - name: python3-setuptools_scm
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "setuptools_scm" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/be/ec/2eb3cd785efd67806c46c13a17339708ddc346cbb684eade7a6e6f79536a/pyparsing-3.2.0-py3-none-any.whl
            sha256: 93d9577b88da0bbea8cc8334ee8b918ed014968fd2ec383e868fb8afb1ccef84
            x-checker-data:
              name: pyparsing
              packagetype: bdist_wheel
              type: pypi
          - type: file
            url: https://files.pythonhosted.org/packages/26/9f/ad63fc0248c5379346306f8668cda6e2e2e9c95e01216d2b8ffd9ff037d0/typing_extensions-4.12.2-py3-none-any.whl
            sha256: 04e5ca0351e0f3f85c6853954072df659d0d13fac324d0072316b67d7794700d
            x-checker-data:
              name: typing_extensions
              packagetype: bdist_wheel
              type: pypi
          - type: file
            url: https://files.pythonhosted.org/packages/de/f7/4da0ffe1892122c9ea096c57f64c2753ae5dd3ce85488802d11b0992cc6d/tomli-2.1.0-py3-none-any.whl
            sha256: a5c57c3d1c56f5ccdf89f6523458f60ef716e210fc47c4cfb188c5ba473e0391
            x-checker-data:
              name: tomli
              packagetype: bdist_wheel
              type: pypi
          - type: file
            url: https://files.pythonhosted.org/packages/a0/b9/1906bfeb30f2fc13bb39bf7ddb8749784c05faadbd18a21cf141ba37bff2/setuptools_scm-8.1.0-py3-none-any.whl
            sha256: 897a3226a6fd4a6eb2f068745e49733261a21f70b1bb28fce0339feb978d9af3
            x-checker-data:
              name: setuptools_scm
              packagetype: bdist_wheel
              type: pypi
      - name: python3-typing_extensions
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "typing_extensions" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/26/9f/ad63fc0248c5379346306f8668cda6e2e2e9c95e01216d2b8ffd9ff037d0/typing_extensions-4.12.2-py3-none-any.whl
            sha256: 04e5ca0351e0f3f85c6853954072df659d0d13fac324d0072316b67d7794700d
            x-checker-data:
              type: pypi
              name: typing_extensions
              packagetype: bdist_wheel
      - name: python3-setuptools_rust
        buildsystem: simple
        cleanup: ['*']
        build-commands:
          - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
            --prefix=${FLATPAK_DEST} "setuptools_rust" --no-build-isolation
        sources:
          - type: file
            url: https://files.pythonhosted.org/packages/7d/31/f2289ce78b9b473d582568c234e104d2a342fd658cc288a7553d83bb8595/semantic_version-2.10.0.tar.gz
            sha256: bdabb6d336998cbb378d4b9db3a4b56a1e3235701dc05ea2690d9a997ed5041c
            x-checker-data:
              type: pypi
              name: semantic_version
          - type: file
            url: https://files.pythonhosted.org/packages/d3/6b/99a1588d826ceb108694ba00f78bc6afda10ed5d72d550ae8f256af1f7b4/setuptools_rust-1.10.2.tar.gz
            sha256: 5d73e7eee5f87a6417285b617c97088a7c20d1a70fcea60e3bdc94ff567c29dc
            x-checker-data:
              type: pypi
              name: setuptools-rust
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/e4/7e/d95e7d96d4828e965891af92e43b52a4cd3395dc1c1ef4ee62748d0471d0/bcrypt-4.2.0.tar.gz
        sha256: cf69eaf5185fd58f268f805b505ce31f9b9fc2d64b376642164e9244540c1221
        x-checker-data:
          type: pypi
          name: bcrypt
      # The Cargo sources should be updated whenever bcrypt is updated.
      - bcrypt-cargo-sources.json

  - name: libndp
    buildsystem: autotools
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://github.com/jpirko/libndp/archive/v1.9.tar.gz
        sha256: e564f5914a6b1b799c3afa64c258824a801c1b79a29e2fe6525b682249c65261
        x-checker-data:
          type: anitya
          project-id: 14944
          stable-only: true
          url-template: https://github.com/jpirko/libndp/archive/v$version.tar.gz

  # https://github.com/flathub/com.anydesk.Anydesk/blob/f06549a3749ecbcc99cbbfd7753bfa884746b404/com.anydesk.Anydesk.json#L84-L115
  - name: polkit
    buildsystem: meson
    config-opts:
      - -Dlibs-only=true
      - -Dman=false
      - -Dintrospection=false
      - -Dexamples=false
      - -Dgtk_doc=false
      - -Dauthfw=shadow
    cleanup:
      - /bin/*
      - /etc/pam.d
      - /etc/dbus-1
      - /share/dbus-1/system-services/*
      - /share/polkit-1
      - /share/polkit-1/actions/*
      - /lib/polkit-1
      - /include
    sources:
      - x-checker-data:
          type: anitya
          project-id: 3682
          url-template: >-
            https://gitlab.freedesktop.org/polkit/polkit/-/archive/$version/polkit-$version.tar.gz
        type: archive
        url: >-
          https://gitlab.freedesktop.org/polkit/polkit/-/archive/124/polkit-124.tar.gz
        sha256: 72457d96a0538fd03a3ca96a6bf9b7faf82184d4d67c793eb759168e4fd49e20

  # https://github.com/flathub/org.gnome.NetworkDisplays/blob/5a3369d04e32ccd092e42463de5171f473a8601d/org.gnome.NetworkDisplays.json#LL177C11-L230C11
  - name: NetworkManager
    buildsystem: meson
    build-options:
      cflags: -ltinfo
      cxxflags: -ltinfo
    config-opts:
      - -Dsystemdsystemunitdir=no
      - -Ddbus_conf_dir=/app/etc/dbus-1/system.d
      - -Diptables=/usr/bin/true
      - -Ddnsmasq=/usr/bin/true
      - -Dsession_tracking=no
      - -Dselinux=false
      - -Dsystemd_journal=false
      - -Dlibaudit=no
      - -Dwext=false
      - -Dwifi=false
      - -Dppp=false
      - -Dmodem_manager=false
      - -Dovs=false
      - -Dnmcli=false
      - -Dnmtui=false
      # We need introspection
      - -Dintrospection=true
      - -Dvapi=false
      - -Ddocs=false
      - -Dtests=no
      - -Dfirewalld_zone=false
      - -Dlibpsl=false
      - -Dqt=false
    cleanup:
      - /sbin
      - /etc
      - /include
      - /lib/pkgconfig
      - /libexec
      - /var
      - /share/bash-completion
      - /share/doc
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/NetworkManager/NetworkManager.git
        tag: 1.40.18
        commit: 2db3748ec8162ce948ba52f71b42a258ff8d64ba
        x-checker-data:
          type: anitya
          project-id: 21197
          stable-only: true
          tag-template: $version
          versions:
            # Breaking change in 1.42.x: `dns` will be replaced by `dns-data`, which is incompatible with older NetworkManager on the host system
            <: 1.42.0

      # To fix `Support for given configuration is not implemented` when trying to connect: https://github.com/flathub/com.protonvpn.www/issues/2
      # Copied from https://github.com/flathub/com.github.jkotra.eovpn/blob/670f19e2aee1c9559fbe4eed904e35500843ae88/0001-disable-ownership-check-for-plugins.patch
      - type: patch
        path: patches/NetworkManager/disable-ownership-check-for-plugins.patch

  # https://github.com/flathub/com.github.jkotra.eovpn/blob/670f19e2aee1c9559fbe4eed904e35500843ae88/com.github.jkotra.eovpn.yml#L133C17-L151
  - name: libnma
    buildsystem: meson
    config-opts:
      - -Dmobile_broadband_provider_info=false
      - -Dgtk_doc=false
      - -Dintrospection=false
      - -Dvapi=false
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libnma/-/archive/1.10.6/libnma-1.10.6.tar.gz
        sha256: c88fd3408c4ff166b06179b5ce5186e08a57b64eb8c9b22e055ca0dbc5e8002b
        x-checker-data:
          type: anitya
          project-id: 230112
          stable-only: true
          url-template: https://gitlab.gnome.org/GNOME/libnma/-/archive/$version/libnma-$version.tar.gz

  - name: NetworkManager-openvpn
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/NetworkManager/NetworkManager-openvpn.git
        tag: 1.10.2
        commit: ae9575dd07cc2d2d51ec8d0297823e07017cb6e6
        x-checker-data:
          type: anitya
          project-id: 69977
          stable-only: true
          tag-template: $version
          versions:
            # 1.10.4 causes connection failure
            <: 1.10.4

  # Logs submission when reporting a bug requires journalctl
  # https://github.com/flathub/org.gnome.Logs/blob/master/org.gnome.Logs.json#L69C9-L146C11
  - name: systemd
    buildsystem: meson
    config-opts:
      - --libdir=lib
      - -Drootprefix=/app
      - -Drootlibdir=/app/lib
      - -Dsysconfdir=/app/etc
      - -Ddocdir=/app/share/doc
      - -Dsysvinit-path=/app/etc/init.d
      - -Dfdisk=false
      - -Ddbus=false
      - -Dutmp=false
      - -Dhibernate=false
      - -Dldconfig=false
      - -Dresolve=false
      - -Defi=false
      - -Dtpm=false
      - -Denvironment-d=false
      - -Dbinfmt=false
      - -Dcoredump=false
      - -Dlogind=false
      - -Dhostnamed=false
      - -Dlocaled=false
      - -Dmachined=false
      - -Dportabled=false
      - -Dnetworkd=false
      - -Dtimedated=false
      - -Dtimesyncd=false
      - -Dremote=false
      - -Dnss-myhostname=false
      - -Dnss-mymachines=false
      - -Dnss-resolve=false
      - -Dnss-systemd=false
      - -Dfirstboot=false
      - -Drandomseed=false
      - -Dbacklight=false
      - -Dvconsole=false
      - -Dquotacheck=false
      - -Dsysusers=false
      - -Dtmpfiles=false
      - -Dimportd=false
      - -Dhwdb=false
      - -Drfkill=false
      - -Dman=false
      - -Dhtml=false
      - -Dbashcompletiondir=no
      - -Dzshcompletiondir=no
    cleanup:
    # - /bin
      - /etc
      - /lib/libudev*
      - /lib/kernel
      - /lib/modprobe.d
      - /lib/rpm
      - /lib/sysctl.d
    # - /lib/systemd
      - /lib/udev
      - /app/share/doc
      - /share/dbus-1
      - /share/doc
      - /share/factory
      - /share/glib-2.0
      - /share/icons
      - /share/man
      - /share/pkgconfig
      - /share/polkit-1
      - /share/runtime
    sources:
      - type: git
        url: https://github.com/systemd/systemd.git
        tag: v255


  ######### Cryptography #########

  # https://github.com/flathub/org.gajim.Gajim/blob/cb9cb26dd58acea79c50b316fb66a171b54c18e1/org.gajim.Gajim.yaml#LL66-L131C81
  - name: python3-pycparser
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "pycparser" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/13/a3/a812df4e2dd5696d1f351d58b8fe16a405b234ad2886a0dab9183fb78109/pycparser-2.22-py3-none-any.whl
        sha256: c3702b6d3dd8c7abc1afa565d7e63d53a1d0bd86cdc24edd75470f4de499cfcc
        x-checker-data:
          type: pypi
          name: pycparser
          packagetype: bdist_wheel

  - name: python3-cffi
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/fc/97/c783634659c2920c3fc70419e3af40972dbaf758daa229a7d6ea6135c90d/cffi-1.17.1.tar.gz
        sha256: 1c39c6016c32bc48dd54561950ebd6836e1670f2ae46128f67cf49e789c52824
        x-checker-data:
          type: pypi
          name: cffi

  - name: python3-asn1crypto
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "asn1crypto" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/c9/7f/09065fd9e27da0eda08b4d6897f1c13535066174cc023af248fc2a8d5e5a/asn1crypto-1.5.1-py2.py3-none-any.whl
        sha256: db4e40728b728508912cbb3d44f19ce188f218e9eba635821bb4b68564f8fd67
        x-checker-data:
          type: pypi
          name: asn1crypto
          packagetype: bdist_wheel

  - name: python3-idna
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "idna" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/76/c6/c88e154df9c4e1a2a66ccf0005a88dfb2650c1dffb6f5ce603dfbd452ce3/idna-3.10-py3-none-any.whl
        sha256: 946d195a0d259cbba61165e88e65941f16e9b36ea6ddb97f00452bae8b1287d3
        x-checker-data:
          type: pypi
          name: idna
          packagetype: bdist_wheel

  - name: python3-cryptography
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "cryptography" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/4e/49/80c3a7b5514d1b416d7350830e8c422a4d667b6d9b16a9392ebfd4a5388a/cryptography-43.0.3-cp37-abi3-manylinux_2_28_aarch64.whl
        sha256: 443c4a81bb10daed9a8f334365fe52542771f25aedaf889fd323a853ce7377d6
        only-arches:
          - aarch64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query: .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp37-abi3-manylinux_2_28_aarch64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel

      - type: file
        url: https://files.pythonhosted.org/packages/0e/16/a28ddf78ac6e7e3f25ebcef69ab15c2c6be5ff9743dd0709a69a4f968472/cryptography-43.0.3-cp37-abi3-manylinux_2_28_x86_64.whl
        sha256: 74f57f24754fe349223792466a709f8e0c093205ff0dca557af51072ff47ab18
        only-arches:
          - x86_64
        x-checker-data:
          type: json
          url: https://pypi.org/pypi/cryptography/json
          version-query: .info.version
          url-query: .releases | .[$version][] | select(.filename=="cryptography-"
            + $version + "-cp37-abi3-manylinux_2_28_x86_64.whl") | .url
          name: cryptography
          packagetype: bdist_wheel

  # https://github.com/flathub/net.lutris.Lutris/blob/7bd51222b8076abd8fcbfe9cb0e4d6e70bafca24/net.lutris.Lutris.yml#L647C1-L740C81
  - name: python-ninja # needed by dbus-python
    buildsystem: simple
    build-commands:
      - python3 setup.py build -j${FLATPAK_BUILDER_N_JOBS} -DARCHIVE_DOWNLOAD_DIR="${FLATPAK_BUILDER_BUILDDIR}"
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    cleanup: ['*']
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/37/2c/d717d13a413d6f7579cdaa1e28e6e2c98de95461549b08d311c8a5bf4c51/ninja-1.11.1.1.tar.gz
        sha256: 9d793b08dd857e38d0b6ffe9e6b7145d7c485a42dcfea04905ca0cdb6017cc3c
        x-checker-data:
          type: pypi
          name: ninja
      - type: file
        url: https://github.com/Kitware/ninja/archive/refs/tags/v1.11.1.g95dee.kitware.jobserver-1.tar.gz
        sha256: 7ba84551f5b315b4270dc7c51adef5dff83a2154a3665a6c9744245c122dd0db
    modules:
      - pip-resources.python-skbuild.yaml
      - name: python-skbuild
        buildsystem: simple
        build-commands:
          - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
            .
        cleanup: ['*']
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/56/54/2beb41f3fcddb4ea238634c6c23fe93115090d8799a45f626a83e6934c16/scikit_build-0.18.1.tar.gz
            sha256: a4152ac5a084d499c28a7797be0628d8366c336e2fb0e1a063eb32e55efcb8e7
            x-checker-data:
              type: pypi
              name: scikit-build
        modules:
          - name: python-setuptools-scm
            buildsystem: simple
            build-commands:
              - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                .
            cleanup: ['*']
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/4f/a4/00a9ac1b555294710d4a68d2ce8dfdf39d72aa4d769a7395d05218d88a42/setuptools_scm-8.1.0.tar.gz
                sha256: 42dea1b65771cba93b7a515d65a65d8246e560768a66b9106a592c8e7f26c8a7
                x-checker-data:
                  type: pypi
                  name: setuptools_scm
            modules:
              - name: python-typing-extensions
                buildsystem: simple
                build-commands:
                  - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                    .
                cleanup: ['*']
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/df/db/f35a00659bc03fec321ba8bce9420de607a1d37f8342eee1863174c69557/typing_extensions-4.12.2.tar.gz
                    sha256: 1a7ead55c7e559dd4dee8856e3a88b41225abfe1ce8df57b7c13915fe121ffb8
                    x-checker-data:
                      type: pypi
                      name: typing_extensions
              - name: python-tomli
                buildsystem: simple
                build-commands:
                  - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                    .
                cleanup: ['*']
                sources:
                  - type: archive
                    url: https://files.pythonhosted.org/packages/1e/e4/1b6cbcc82d8832dd0ce34767d5c560df8a3547ad8cbc427f34601415930a/tomli-2.1.0.tar.gz
                    sha256: 3f646cae2aec94e17d04973e4249548320197cfabdf130015d023de4b74d8ab8
                    x-checker-data:
                      type: pypi
                      name: tomli
          - name: python-distro # also needed by Lutris, do not add a cleanup property here!
            buildsystem: simple
            build-commands:
              - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
                .
            sources:
              - type: archive
                url: https://files.pythonhosted.org/packages/fc/f8/98eea607f65de6527f8a2e8885fc8015d3e6f5775df186e443e0964a11c3/distro-1.9.0.tar.gz
                sha256: 2fa77c6fd8940f116ee1d6b94a2f90b13b5ea8d019b98bc8bafdcabcdd9bdbed
                x-checker-data:
                  type: pypi
                  name: distro

  - name: python-meson # needed by dbus-python, the meson version shipped by the SDK is too old (0.59<0.60)
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" --ignore-installed
        .
    cleanup: ['*']
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/77/fc/2674a4c82b7b7b13e98a9f8debb5b4b616f1a91155d30d9efa7d864009cf/meson-1.6.0.tar.gz
        sha256: 999b65f21c03541cf11365489c1fad22e2418bb0c3d50ca61139f2eec09d5496
        x-checker-data:
          type: pypi
          name: meson

  # https://github.com/flathub/net.lutris.Lutris/blob/7bd51222b8076abd8fcbfe9cb0e4d6e70bafca24/net.lutris.Lutris.yml#L772-L786
  - name: python-dbus
    buildsystem: simple
    build-commands:
      # Setting `PYTHONPATH` and using the deprecated `./setup.py install`
      # in the following line are workarounds to force usage of the newer
      # meson version installed above
      #
      # The next FreeDesktop SDK update should make this (and installing
      # our own version of meson) unnecessary.
      - PYTHONPATH=/app/lib/python3.11/site-packages python3 ./setup.py install --prefix="${FLATPAK_DEST}"
        --root=/
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-1.3.2.tar.gz
        sha256: ad67819308618b5069537be237f8e68ca1c7fcc95ee4a121fe6845b1418248f8
        x-checker-data:
          type: anitya
          project-id: 402
          url-template: https://dbus.freedesktop.org/releases/dbus-python/dbus-python-$version.tar.gz

  # For network status detection: https://github.com/ProtonVPN/proton-vpn-gtk-app/blob/a6a3ea0b2a0c17ebbba4eb9f80c8b164092050b9/proton/vpn/app/gtk/services/reconnector/network_monitor.py#L41
  - name: iproute2
    buildsystem: autotools
    make-install-args:
      - PREFIX=${FLATPAK_DEST}
      - SBINDIR=${FLATPAK_DEST}/bin
      - CONFDIR=${FLATPAK_DEST}/etc/iproute2
    sources:
      - type: archive
        url: https://www.kernel.org/pub/linux/utils/net/iproute2/iproute2-6.11.0.tar.xz
        sha256: 1f795398a04aeaacd06a8f6ace2cfd913c33fa5953ca99daae83bb5c534611c3
        x-checker-data:
          project-id: 1392
          stable-only: true
          type: anitya
          url-template: https://www.kernel.org/pub/linux/utils/net/iproute2/iproute2-$version.tar.xz

  ######### Proton Services #########

  - name: python-proton-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//46' "expandvars" "requests" "python-gnupg" "pyopenssl" "aiohttp" "pyxdg" -o pip-resources.python-proton-core
      # `expandvars` is required by `yarl`
      # https://github.com/ProtonVPN/python-proton-core/blob/8ab41013fcedd8fe16dffe0992f60cbdbd01fe0b/setup.py#L12C23-L12C129
      - pip-resources.python-proton-core.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-core
        tag: v0.3.3
        commit: d8b919e33770f772a863354ff4606770418a067a
        x-checker-data:
          type: anitya
          project-id: 369954
          tag-template: v$version

  - name: python-proton-keyring-linux
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//46' "keyring" -o pip-resources.python-proton-keyring-linux
      # https://github.com/ProtonVPN/python-proton-keyring-linux/blob/5ff3c7f9a1a162836649502dd23c2fbe1f487d73/setup.py#L12C39-L12C46
      # Remove the cryptography module as it has been included above
      - pip-resources.python-proton-keyring-linux.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-keyring-linux
        tag: v0.1.0
        commit: f17038fc9636796c02f71e8395fbd19417f6db0b
        x-checker-data:
          type: anitya
          project-id: 369953
          tag-template: v$version

  - name: python-proton-vpn-api-core
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//46' "distro" "sentry-sdk" "PyNaCl" -o pip-resources.python-proton-vpn-api-core
      # https://github.com/ProtonVPN/python-proton-vpn-api-core/blob/e26e3fa70077d24a53465c87ebdd6026e3c7c080/setup.py#L17-L18C46
      - pip-resources.python-proton-vpn-api-core.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-vpn-api-core
        tag: v0.36.6
        commit: 0932031562a6b7defd5c2234b257f600b89aaa52
        disable-submodules: true
        x-checker-data:
          type: anitya
          project-id: 369944
          tag-template: v$version

  - name: python-proton-vpn-network-manager
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//46' "pygobject" "pycairo" -o pip-resources.python-proton-vpn-network-manager
      # https://github.com/ProtonVPN/python-proton-vpn-network-manager/blob/6ffd04fa0ae88a89d2b733443317066ef23b3ccd/setup.py#L14C63-L14C85
      - pip-resources.python-proton-vpn-network-manager.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/python-proton-vpn-network-manager
        tag: v0.9.7
        commit: 3f5c929d2d9052b1f26f3583f79a7b7e0525935c
        disable-submodules: true
        x-checker-data:
          type: anitya
          project-id: 369947
          tag-template: v$version
      - type: patch
        path: patches/python-proton-vpn-network-manager/fix-ip-path.patch

  - name: python-proton-vpn-local-agent
    buildsystem: simple
    build-commands:
      - bsdtar -Oxf python-proton-vpn-local-agent.deb data.tar.xz | bsdtar -xf -
      - |
        PYTHON_VERSION=$(python3 -c 'import sys; print("{}.{}".format(*sys.version_info))');
        install -m755 usr/lib/python3/dist-packages/proton/vpn/local_agent.abi3.so "${FLATPAK_DEST}/lib/python${PYTHON_VERSION}/site-packages/proton/vpn/local_agent.abi3.so"
    sources:
      - type: file
        only-arches: [x86_64]
        dest-filename: python-proton-vpn-local-agent.deb
        url: https://repo.protonvpn.com/debian/dists/stable/main/binary-amd64/python3-proton-vpn-local-agent_1.1.4_amd64.deb
        sha256: ae43ef3251aeac35f495325a93dffef88ea34c743a5db4894b1e8bbd86fdffe0
        x-checker-data:
          type: debian-repo
          package-name: python3-proton-vpn-local-agent
          root: https://repo.protonvpn.com/debian
          dist: stable
          component: main
      - type: file
        only-arches: [aarch64]
        dest-filename: python-proton-vpn-local-agent.deb
        url: https://repo.protonvpn.com/debian/dists/stable/main/binary-arm64/python3-proton-vpn-local-agent_1.1.4_arm64.deb
        sha256: 23641305c77a752964c3824cc0174fff249bdcf63ca1213b4325fb9482218273
        x-checker-data:
          type: debian-repo
          package-name: python3-proton-vpn-local-agent
          root: https://repo.protonvpn.com/debian
          dist: stable
          component: main

  - name: proton-vpn-gtk-app
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} "." --no-build-isolation

      - install -Dm644 rpmbuild/SOURCES/protonvpn-app.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - desktop-file-edit --set-icon ${FLATPAK_ID} --set-key Exec --set-value 'protonvpn-app
        %u' ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop

      - install -Dm644 rpmbuild/SOURCES/proton-vpn-logo.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      # Export icons that can be used in the status bar: https://github.com/flathub/com.protonvpn.www/issues/100
      # Icons to be exported must have names following the pattern: ${FLATPAK_ID}.icon_name.svg
      - |
        PYTHON_VERSION=$(python3 -c 'import sys; print("{}.{}".format(*sys.version_info))')
        PYTHONPATH=${FLATPAK_DEST}/lib/python${PYTHON_VERSION}/site-packages
        for icon in maintenance-icon proton-vpn-sign state-connected state-disconnected state-error
        do
          mv ${PYTHONPATH}/proton/vpn/app/gtk/assets/icons/${icon}.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.${icon}.svg
          ln -s ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.${icon}.svg ${PYTHONPATH}/proton/vpn/app/gtk/assets/icons/${icon}.svg
        done
      - install -Dm644 com.protonvpn.www.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
    modules:
      # flatpak-pip-generator --checker-data --yaml --runtime='org.gnome.Sdk//46' "pygobject" "pycairo" -o pip-resources.proton-vpn-gtk-app
      # https://github.com/ProtonVPN/proton-vpn-gtk-app/blob/9bb65236353d646b07ead7b417d3828b12b55b7c/setup.py#L12-L19
      - pip-resources.proton-vpn-gtk-app.yaml
    sources:
      - type: git
        url: https://github.com/ProtonVPN/proton-vpn-gtk-app
        tag: v4.7.4
        commit: 01676a4da1fcaf18b03a8b22c8590de3d3fbe58f
        disable-submodules: true
        x-checker-data:
          type: anitya
          project-id: 369943
          tag-template: v$version
          is-main-source: true

      - type: patch
        path: patches/proton-vpn-gtk-app/fix-tray-icons.patch

      - type: file
        path: com.protonvpn.www.metainfo.xml
